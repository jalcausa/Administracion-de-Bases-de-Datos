--------------------- PRACTICA 6: TRIGGERS ---------------------------------

-------------------------- EJERCICIO 1 ------------------------------------

CREATE TABLE MENSAJES (Codigo NUMBER(20) PRIMARY KEY, Texto VARCHAR2(200));

CREATE TABLE AUDITA_MENSAJES(Quien VARCHAR2(20), Como VARCHAR2(20), Cuando DATE);

CREATE OR REPLACE TRIGGER T_AUDITA AFTER INSERT OR UPDATE OR DELETE
ON MENSAJES
BEGIN
    IF INSERTING THEN
        INSERT INTO AUDITA_MENSAJES VALUES (USER, 'INSERT', SYSDATE);
    ELSIF UPDATING THEN
        INSERT INTO AUDITA_MENSAJES VALUES (USER, 'UPDATE', SYSDATE);
    ELSE
        INSERT INTO AUDITA_MENSAJES VALUES (USER, 'DELETE', SYSDATE);
    END IF;    
END;
/

INSERT INTO MENSAJES VALUES (12345,'No tiene permiso para operar en este formulario');

------------------------ EJERCICIO 2 ----------------------------------------

ALTER TABLE MENSAJES ADD TIPO VARCHAR2(30) DEFAULT('INFORMACION') NOT NULL;

-- INSERT INTO MENSAJES VALUES (56, 'No tiene permiso para operar en este formulario', 'INFORMACION');

ALTER TABLE MENSAJES ADD CONSTRAINT chk_tipo CHECK (TIPO IN ('INFORMACION', 'RESTRICCION', 'ERROR', 'AVISO', 'AYUDA'));

CREATE TABLE MENSAJES_Info (
Tipo VARCHAR2(30) PRIMARY KEY, 
Cuantos_Mensajes NUMBER(2),
Ultimo VARCHAR2(200),
CONSTRAINT chk_tipo_msj_info CHECK (TIPO IN ('INFORMACION', 'RESTRICCION', 'ERROR', 'AVISO', 'AYUDA')));

INSERT INTO MENSAJES_Info (TIPO, CUANTOS_MENSAJES)
    SELECT TIPO, COUNT (*)
    FROM MENSAJES
    GROUP BY TIPO;
    
CREATE OR REPLACE TRIGGER TR_MENSAJES BEFORE INSERT OR DELETE OR UPDATE ON MENSAJES
    FOR EACH ROW
BEGIN
    IF DELETING OR UPDATING THEN
        UPDATE MENSAJES_INFO
            SET CUANTOS_MENSAJES = CUANTOS_MENSAJES - 1,
                ULTIMO = NULL
            WHERE TIPO = :OLD.TIPO; 
    END IF;
    IF INSERTING OR UPDATING THEN
        UPDATE MENSAJES_INFO
            SET CUANTOS_MENSAJES = CUANTOS_MENSAJES + 1,
                ULTIMO = :NEW.TEXTO
            WHERE TIPO = :NEW.TIPO;
    END IF;   
END;
/

-- Hay que inicializar MENSAJES_INFO para que funcione el trigger
-- en la tabla tiene que haber una entrada para cada tipo

INSERT INTO MENSAJES VALUES(30, 'PEPE', 'ERROR');